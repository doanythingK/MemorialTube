# 메모리얼튜브 추모영상 생성 서비스 설계 문서 v0.3 (결정본·수정안)

작성일: 2026-02-11  
기준 문서: `docs/MemorialTube_추모영상_서비스_설계_v0.2.md`  
대상: 외부 유료 API 미사용, Python 기반 로컬/클라우드 겸용

---

## 1. 문서 목적

본 문서는 v0.2에서 열린 의사결정 항목 `D-01 ~ D-15`를 확정하고, 구현 시 바로 적용할 수 있는 운영 정책으로 고정하기 위한 결정본입니다.

---

## 2. 전제(변경 없음)

1. 입력: 반려동물 사진 N장  
2. 출력: 최종 영상 `1920x1080(16:9)` 고정  
3. 캔버스 맞춤: 업스케일 금지, outpainting 중심  
4. 전환: `사진 i -> 사진 i+1` 클립 생성  
5. 마지막 사진: 단독 클립 생성  
6. 최종: 모든 클립을 연결해 MP4 렌더링

---

## 3. 의사결정 확정표 (D-01 ~ D-15)

| ID | 확정 결정 | 선택 이유 | 재검토 조건 |
|---|---|---|---|
| D-01 | **최소 입력 해상도 2단계**: (A) 하드 최소 `640x480`(EXIF 보정 후 `긴 변>=640`, `짧은 변>=480`) 미만은 차단 (B) `640x480 ~ 800x600` 구간은 **업로드 허용 + 품질 경고 + 안전 경로 강제** (C) 권장 `긴 변>=800`, `짧은 변>=600` | “800x600 미만 전면 차단”은 실제 사용자 사진(과거/메신저 저장본)에서 이탈이 커질 가능성이 있어, **완주율(결과 제공)**을 우선 확보하기 위한 절충안입니다. | 저해상도 구간에서 불만/환불/재시도율이 높으면 (B) 구간 축소 또는 하드 최소 상향 |
| D-02 | 다운스케일 예외 상한 고정: 16:9는 `1920x1080`, 비16:9는 중간 상한 `1440x1080` | 최종 고정 해상도와 비16:9 안정 경로(4:3 안전영역)를 동시에 만족시키는 단순한 상한입니다. | 입력 분포가 고해상도 중심으로 바뀌거나 품질 이슈가 상한에서 반복되면 재검토 |
| D-03 | 전환 프레임 고정 수준: **혼합 정책 고정(0프레임/마지막 프레임 픽셀 고정 + 중간 프레임 생성)** + 경계 블렌딩(고정 프레임 인접 2~5프레임) | 시작/끝 일치성(사용자 인지)을 확보하면서도 중간 구간 자연스러움을 확보하기 위한 균형점입니다. | 경계 튐/이질감(“툭 끊김”) 신고 증가 시 블렌딩 구간/전환 길이 재조정 |
| D-04 | 전환 생성 방식: 생성형 전환 기본, 실패 시 클래식 전환 자동 폴백 | 프롬프트 반영 요구와 결과 제공(완주율) 두 목표를 동시에 만족합니다. | GPU 처리시간 급증 또는 생성 실패율 상승 시 기본 모드(생성형) 재선정 |
| D-05 | 마지막 단독 클립: 저강도 모션 기본(줌/패닝/약한 패럴랙스), 생성형은 옵션 | 마지막 컷은 “기억 보존” 성격이 강하므로 피사체 변형 리스크를 최소화합니다. | 사용자 선호가 생성형 중심으로 명확해지면 옵션 기본값 조정 |
| D-06 | 자동 폴백: 단계별 재시도 후 안전 경로 강제(outpaint 안전배경, transition 클래식) | 실패 시 전체 중단보다 “완성본 제공”이 운영 안정성과 CS 대응에 유리합니다. | 폴백 결과 불만 비율이 높으면 품질게이트/재시도 정책 강화 |
| D-07 | 재시도/백오프: 잡별 제한 재시도 + 지수 백오프(전환/아웃페인트는 2회까지 권장) | 생성형 단계는 일시 실패가 잦을 수 있어, 1회보다 **2회**가 완료율에 유리한 경우가 많습니다. | 큐 대기시간 증가/비용 급증 시 재시도 횟수 하향 |
| D-08 | 부분 재생성 범위: 클립 단위 재생성(프로젝트 전체 재생성은 선택) | 장애 구간만 재처리하여 대기시간과 비용을 줄입니다. | 클립 의존성(스타일/시드/템플릿) 문제가 커지면 범위를 확장 |
| D-09 | 프롬프트 정책: 프로젝트 공통 프롬프트 + 사진별 추가 프롬프트 허용 + 금칙어/길이 제한(운영 안전) | 사용자 제어성과 템플릿 일관성 확보 + 운영 리스크(과도 입력/비정상 프롬프트) 완화 목적입니다. | 입력 복잡도로 이탈 증가 시 UI 단순화 및 사진별 프롬프트 축소 |
| D-10 | 템플릿 범위: MVP 2종 고정(클래식, 시네마틱) | 초기 개발 범위 통제와 품질 확보를 위한 최소 구성이 적절합니다. | 선호도 데이터 축적 후 점진 확장 |
| D-11 | 미리보기: 저해상도 프리뷰 **854x480(480p)** 제공 후 최종 렌더 | 960x540 대비 연산/전송 부담이 더 낮고, 프리뷰 목적(흐름 확인)에 충분한 해상도입니다. | 프리뷰에서 자막 가독성 불만 증가 시 960x540로 상향 |
| D-12 | 저장/만료: **원본 14일, 중간산출물 7일, 최종 30일, 다운로드 링크 48시간** | 중간산출물 3일은 부분 재생성/CS 대응에 짧을 수 있어 7일로 완화합니다. 링크 24시간은 사용자 재접속 편의가 낮아 48시간으로 조정합니다. | 법무/보안 정책 변경 또는 스토리지 비용 급증 시 즉시 재조정 |
| D-13 | 실패 알림: 앱 내 알림 기본 + 이메일 알림(사용자 동의 시) | 즉시성(앱)과 이탈 사용자 복귀(이메일)를 동시에 확보합니다. | 도달률/클릭률 낮으면 채널 재구성(예: SMS는 별도 동의 전제) |
| D-14 | 실행 프로파일: `docker-compose.local.yml` / `docker-compose.cloud.yml` 분리 | 로컬 개발과 운영 배포 설정 충돌을 줄여 운영 안정성을 확보합니다. | 운영 단순화 필요 시 profile 기반 단일 파일 통합 검토 |
| D-15 | 모니터링 최소셋: 구조화 오류로그 + 핵심 메트릭 + Job Trace ID + OOM/타임아웃 카운트 | “원인 추적 가능한 최소 단위”를 처음부터 확보해야 장애 분석 시간이 짧아집니다. | 장애 분석 시간이 길면 분산 트레이싱 도입 |

---

## 4. 확정 정책 상세

### 4.1 입력 검증 정책

1. 이미지 포맷: `jpg/jpeg/png/webp` 허용  
2. EXIF 방향 보정 후 해상도 판정  
3. 하드 최소 해상도: `긴 변>=640`, `짧은 변>=480`  
4. `640x480` 미만: 업로드 차단, 오류코드 `ERR_MIN_RESOLUTION_HARD` 반환  
5. `640x480 ~ 800x600` 구간: 업로드 허용, 경고 플래그 `WARN_LOW_RES` 부여 + **안전 경로 강제**(4.3/4.4의 안전 폴백 우선)  
6. 파일 손상/디코딩 실패 시 `ERR_IMAGE_DECODE` 반환

---

### 4.2 캔버스 생성 정책

1. **16:9 입력**  
2. `w<=1920 && h<=1080`이면 스케일 변경 없이 outpainting으로 `1920x1080` 완성  
3. `w>1920 || h>1080`이면 비율 유지 축소(예외 허용) 후 처리

4. **비16:9 입력**  
5. 필요 시 비율 유지 축소로 `1440x1080` 상한 내 진입  
6. outpainting으로 `1440x1080` 생성 후 다시 outpainting으로 `1920x1080` 완성

---

### 4.3 피사체 보호(outpainting)

1. 세그멘테이션 마스크로 반려동물 중심 영역 보호  
2. 생성은 배경/가장자리 중심으로 제한  
3. 품질게이트 미달 시 재시도 후 안전 배경 폴백 적용  
4. `WARN_LOW_RES`(저해상도)일 경우: 재시도 횟수는 최소화하고 **안전 배경 폴백을 더 빠르게 적용**(불필요한 생성 반복 방지)

---

### 4.4 전환 클립 정책

1. 기본 모드: 생성형 전환  
2. 클립 완성 후 프레임 고정:  
   - 프레임 0을 사진 i로 **픽셀 고정(강제 합성)**  
   - 마지막 프레임을 사진 i+1로 **픽셀 고정(강제 합성)**  
3. 경계 튐이 있으면 시작/끝 인접 2~5프레임에 약한 블렌딩 적용  
4. 생성 실패(또는 품질게이트 미달) 시 클래식 전환(크로스페이드 + Ken Burns)으로 폴백  
5. `WARN_LOW_RES`일 경우: 기본 전환을 **클래식 전환 우선**으로 내려도 됨(운영 초기값으로는 “생성형 1회 시도 후 즉시 폴백” 권장)

---

### 4.5 마지막 단독 클립 정책

1. 기본 길이: **4초(결정값)**  
2. 저강도 모션 기본(줌/패닝/미세 패럴랙스)  
3. 피사체 변형이 감지되면 정지 프레임 기반 연출로 자동 전환  
4. `WARN_LOW_RES`일 경우: 패럴랙스 비활성(줌/패닝만)로 제한

---

### 4.6 재시도/백오프 정책

아래 값은 초기 운영 데이터가 없어 일부는 `추측입니다`. v0.4에서 로그 기반 재조정합니다.

1. `UploadJob`: 최대 1회 재시도, 백오프 10초  
2. `OutpaintJob`: **최대 2회 재시도**, 백오프 30초 -> 120초  
3. `TransitionJob`: **최대 2회 재시도**, 백오프 60초 -> 180초 (이후 폴백)  
4. `LastClipJob`: 최대 1회 재시도, 백오프 60초  
5. `RenderJob`: 최대 2회 재시도, 백오프 20초 -> 60초  
6. `DeliverJob`: 최대 3회 재시도, 백오프 10초 -> 30초 -> 90초  
7. 비재시도 오류(손상 파일, 권한 오류)는 즉시 실패 처리  
8. `WARN_LOW_RES`일 경우: 생성형 단계 재시도 횟수를 0~1로 제한(무의미한 반복 방지)

---

### 4.7 저장/만료 정책

아래 보관기간은 법무 확정 전 운영 기본안이며 일부 값은 `추측입니다`.

1. 원본 사진: 14일 후 자동 삭제  
2. 중간 산출물(outpaint/clip): **7일 후 자동 삭제**  
3. 최종 영상: 30일 후 자동 삭제  
4. 다운로드 링크: **48시간 만료**(재발급 허용)  
5. 사용자 즉시 삭제: 원본/중간/최종 모두 지원

---

### 4.8 미리보기 정책

1. 프리뷰 해상도: **854x480(결정값)**  
2. 프리뷰는 워터마크 포함 가능  
3. 프리뷰 승인 후 최종 렌더 실행

---

### 4.9 모니터링/로그 정책

1. 모든 Job에 `project_id`, `job_id`, `trace_id` 부여  
2. 구조화 로그(JSON) 기본  
3. 핵심 메트릭:  
   - 잡 성공률/실패율  
   - 단계별 평균 처리시간  
   - 재시도 횟수 분포  
   - 큐 대기시간  
   - GPU 사용률/메모리 사용률  
   - **OOM(메모리 부족) 발생 횟수**, **타임아웃 횟수**, 폴백 발생률

---

### 4.10 로컬/클라우드 실행 정책

1. 코드베이스는 단일 유지  
2. 배포 정의는 분리:  
   - 로컬: `docker-compose.local.yml`  
   - 클라우드: `docker-compose.cloud.yml`  
3. 환경 차이는 `.env.local`, `.env.cloud`로 분리

---

## 5. 구현 우선순위(실행 순서)

1. 입력 검증 + 업로드 파이프라인  
2. outpainting 모듈 + 피사체 보호 + 폴백  
3. 전환 클립 모듈 + 프레임 고정 로직  
4. 마지막 단독 클립 모듈  
5. 렌더/병합 모듈(FFmpeg)  
6. 모니터링/재시도/부분 재생성  
7. 프리뷰/다운로드/만료 처리

---

## 6. 현재 알 수 없는 항목

1. 목표 SLA(예: 평균 처리시간, P95)는 트래픽/GPU 사양 정보가 없어 `알 수 없습니다`.  
2. 동시 작업량 기준 최적 워커 수는 실제 벤치마크 전에는 `확실하지 않음`입니다.  
3. 템플릿별 사용자 선호도는 운영 전 데이터가 없어 `알 수 없습니다`.

---

## 7. v0.3 적용 결과

1. v0.2에서 열린 의사결정 항목은 모두 확정되었습니다.  
2. 구현팀은 본 문서 기준으로 API/Worker/Queue 상세 설계로 바로 진입할 수 있습니다.
