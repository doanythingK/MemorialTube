# 메모리얼튜브 구현 현황 체크포인트 v0.5

작성일: 2026-02-12  
기준 브랜치: `main`  
대상 저장소: `MemorialTube`

## 1. 문서 목적

현재 코드 기준으로 **어디까지 구현되었는지**와 **어디부터 이어서 구현해야 하는지**를 정리합니다.

## 2. 현재 구현 완료 범위

### 2.1 API (FastAPI)

1. Job API
- `POST /api/v1/jobs/test`
- `POST /api/v1/jobs/canvas`
- `POST /api/v1/jobs/transition`
- `POST /api/v1/jobs/last-clip`
- `POST /api/v1/jobs/render`
- `POST /api/v1/jobs/pipeline`
- `GET /api/v1/jobs/{job_id}` (진행률/단계 상세 포함)
- `GET /api/v1/jobs/{job_id}/runtime` (runtime 상세 전용)
- `GET /api/v1/jobs`
- `POST /api/v1/jobs/{job_id}/cancel`

2. Project API
- `POST /api/v1/projects`
- `GET /api/v1/projects`
- `GET /api/v1/projects/{project_id}`
- `POST /api/v1/projects/{project_id}/assets`
- `GET /api/v1/projects/{project_id}/assets`
- `POST /api/v1/projects/{project_id}/run`
- `POST /api/v1/projects/{project_id}/cancel`

### 2.2 작업 상태/취소/진행률

1. `job_runtimes` 테이블 기반 상세 상태 저장
- `stage`
- `progress_percent`
- `detail_message`
- `cancel_requested`

2. 취소 흐름
- API에서 취소 요청 시 `cancel_requested=true`
- 워커가 단계 사이에서 취소 요청을 감지하면 중단 처리
- 중단 시 runtime은 `canceled`, job status는 `failed`로 기록

3. 단계 상세화
- Canvas: `canvas_start -> canvas_generate -> canvas_validate -> canvas_done`
- Transition: `transition_start -> transition_generate -> transition_validate -> transition_done`
- Last clip: `last_clip_start -> last_clip_generate -> last_clip_finalize -> last_clip_done`
- Render: `render_start -> render_concat -> render_finalize -> render_done`
- Pipeline: `pipeline_prepare` 이후 단계별 진행률 이벤트 반영

### 2.3 파이프라인/도메인 동작

1. 전체 파이프라인 오케스트레이션
- Canvas -> Transition들 -> LastClip -> Final Render

2. 정책 반영
- 전환 길이 6초/10초 선택
- 생성형 전환 실패 시 폴백 경로 유지
- 경로 보안: `data/`, `STORAGE_ROOT` 하위만 허용

3. 프로젝트 실행 중복 방지
- 같은 프로젝트에서 활성 Job이 있으면 `/run` 409 차단

### 2.4 문서

1. `README.md`에 진행률/취소 API 및 주요 `stage` 목록 반영

## 3. 현재 확실하지 않은 항목

1. 런타임 E2E 검증 결과는 **확실하지 않음**
- 이유: 현재 작업 환경에서 `fastapi`/`pip` 설치가 막혀 실제 서버 기동 및 API 호출 테스트를 완료하지 못했습니다.

2. 운영 SLA(P95, 동시성 한계)는 **알 수 없습니다**
- 이유: 실측 벤치마크 데이터가 아직 없습니다.

## 4. 다음 구현 시작 지점 (우선순위)

### P0 (바로 시작)

1. 로컬 실행 환경 자동화
- `setup.sh` 추가 (python/venv/pip/requirements/ffmpeg 체크)
- 설치 실패 시 원인별 메시지 출력

2. E2E 스모크 테스트
- 최소 시나리오: 프로젝트 생성 -> 에셋 업로드 -> run -> progress 조회 -> cancel -> 상태 확인
- API 자동 테스트 스크립트 또는 `pytest` 추가

3. 취소 안정성 보강
- 장시간 추론/ffmpeg 단계에서 중단 요청 반영 지점 추가 점검
- 취소 후 임시 파일 정리 정책 명시

### P1 (다음 단계)

1. DB 마이그레이션 체계 도입
- `alembic` 추가
- `Base.metadata.create_all()` 의존 최소화

2. 상태 모델 보강
- 필요 시 JobStatus에 `canceled` 별도 도입 검토
- ProjectStatus와 JobStatus 동기화 규칙 명확화

3. 관측성 강화
- job별 trace id 기반 구조화 로그 정리
- 단계별 처리 시간/실패 사유 지표 수집

### P2 (품질/운영)

1. 품질게이트 고도화
- 전환/렌더 결과 품질 검사 항목 추가

2. 재시도/폴백 정책 튜닝
- 로그 기반으로 재시도 횟수, 폴백 임계값 조정

3. 배포 정리
- `docker-compose.local.yml`, `docker-compose.cloud.yml` 실운영 기준 점검

## 5. 이어서 작업할 때 권장 순서

1. 환경 셋업 스크립트 작성/검증
2. E2E 스모크 테스트 작성
3. 취소 안정성(중단/정리) 보강
4. DB 마이그레이션 도입
5. 관측성/품질게이트 고도화

## 6. 체크포인트 결론

현재는 **핵심 기능 구현 단계는 진행된 상태**이고, 다음 단계는 **실행 환경 표준화 + 통합 검증 + 운영 안정화**입니다.
