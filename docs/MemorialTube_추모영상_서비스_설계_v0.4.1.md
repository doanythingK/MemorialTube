# 메모리얼튜브 추모영상 생성 서비스 설계 문서 v0.4.1 (결정본)

작성일: 2026-02-12  
기준 문서: `docs/MemorialTube_추모영상_서비스_설계_v0.3.md`  
대상: 외부 유료 API 미사용, Python 기반 로컬/클라우드 겸용  
변경 요약: `1600x900` 고정 + 비율 유지 리사이즈(업/다운) + 여백 채움 정책 + 재시도/폴백 확정값 + `yuv420p` 고정

---

## 1. 문서 목적

본 문서는 v0.3 정책을 유지하되, 최종 출력/캔버스 정책을 `1600x900` 기준으로 확정하고,
운영 핵심값(재시도 횟수, 폴백 진입 조건, 픽셀 포맷)을 고정하기 위한 결정본입니다.

---

## 2. 전제

1. 입력: 반려동물 사진 N장  
2. 출력: 최종 영상 `1600x900(16:9)` 고정  
3. 캔버스 맞춤: 비율 유지 리사이즈(업/다운 허용) + 여백 채움  
4. 전환: `사진 i -> 사진 i+1` 클립 생성  
5. 마지막 사진: 단독 클립 생성  
6. 최종: 모든 클립을 연결해 MP4 렌더링

---

## 3. 의사결정 확정표 (D-01 ~ D-15)

| ID | 확정 결정 | 선택 이유 | 재검토 조건 |
|---|---|---|---|
| D-01 | 최소 입력 해상도 2단계: (A) 하드 최소 `640x480` 미만 차단 (B) `640x480 ~ 800x600` 구간 허용 + `WARN_LOW_RES` | 완주율 확보와 품질 리스크 통제를 병행하기 위함 | 저해상도 불만/재시도율 상승 시 하드 최소 상향 |
| D-02 | 최종 해상도 `1600x900` 고정, 중간 4:3 경로 미사용 | 파이프라인 단순화와 16:9 결과 일관성 확보 | 여백 품질 이슈 반복 시 여백 정책 재조정 |
| D-03 | 전환 프레임 고정: 시작/끝 픽셀 고정 + 중간 프레임 생성, 인접 2~5프레임 블렌딩 | 시작/끝 일치성과 전환 자연스러움 동시 확보 | 경계 튐 증가 시 블렌딩 범위/전환 길이 조정 |
| D-04 | 전환 생성: 생성형 기본, 실패 시 클래식 자동 폴백 | 표현력과 완주율 균형 | 실패율/처리시간 악화 시 기본 모드 재선정 |
| D-05 | 마지막 단독 클립: 저강도 모션 기본, 생성형 옵션 | 피사체 보존 우선 | 선호 변화 시 기본값 조정 |
| D-06 | 단계별 재시도 후 안전 경로 폴백 강제 | 전체 실패보다 결과 제공 우선 | 폴백 불만 증가 시 품질게이트 강화 |
| D-07 | 재시도/백오프: Outpainting/Transition 최대 2회 | 일시 실패 흡수로 완료율 확보 | 큐 적체/비용 급증 시 하향 |
| D-08 | 부분 재생성: 클립 단위 | 대기시간/비용 절감 | 의존성 문제 시 범위 확장 |
| D-09 | 프롬프트: 공통 + 사진별 추가 허용 + 금칙어/길이 제한 | 제어성과 운영 안정성 확보 | 입력 복잡도 이탈 시 단순화 |
| D-10 | 템플릿: MVP 2종(클래식/시네마틱) | 범위 통제 | 데이터 확보 후 확장 |
| D-11 | 프리뷰: `800x450` 제공 | 1600x900의 1/2로 비용/가독성 균형 | 가독성 이슈 시 상향 |
| D-12 | 저장/만료: 원본 14일, 중간 7일, 최종 30일, 링크 48시간 | CS 대응성과 보관 최소화 균형 | 법무/비용 변화 시 조정 |
| D-13 | 실패 알림: 앱 내 기본 + 이메일(동의 시) | 즉시성/복귀율 확보 | 도달률 저하 시 채널 재구성 |
| D-14 | 실행 프로파일: local/cloud compose 분리 | 설정 충돌 완화 | 운영 단순화 시 통합 검토 |
| D-15 | 모니터링: 구조화 로그 + 핵심 메트릭 + Trace ID + OOM/타임아웃 | 장애 원인 추적 최소셋 | 분석 시간 장기화 시 분산 추적 도입 |

---

## 4. 확정 정책 상세

### 4.1 입력 검증

1. 포맷: `jpg/jpeg/png/webp`  
2. EXIF 보정 후 판정  
3. 하드 최소: `긴 변>=640`, `짧은 변>=480`  
4. 미달 시 `ERR_MIN_RESOLUTION_HARD`  
5. `640x480 ~ 800x600` 구간은 업로드 허용 + `WARN_LOW_RES` 플래그  
6. 디코딩 실패 시 `ERR_IMAGE_DECODE`

---

### 4.2 캔버스 생성(핵심)

목표 캔버스: `1600x900`

1. 스케일 팩터: `s = min(1600 / w, 900 / h)`  
2. 리사이즈 결과: `w1 = round(w*s)`, `h1 = round(h*s)`  
3. 중앙 배치: `1600x900` 중앙에 `(w1, h1)` 배치  
4. 패딩: `padX = (1600 - w1)/2`, `padY = (900 - h1)/2`

---

### 4.3 여백 채움 및 폴백

#### 4.3.1 좌/우 여백

1. 조건: `w1 < 1600`  
2. 기본: 좌/우 Outpainting  
3. 피사체 보호: 세그멘테이션 마스크 기반, 생성영역을 좌/우 여백으로 제한

#### 4.3.2 상/하 여백

1. 조건: `h1 < 900`  
2. 기본: 안전 배경 패딩(비생성)

#### 4.3.3 과도 여백 제한

1. 기준: `w1 < 900`이면 좌/우 Outpainting 대신 안전 배경 패딩 적용

#### 4.3.4 폴백 정의(확정)

1. 폴백은 “기본 생성 경로 실패 시 대체 경로로 완성본을 만드는 절차”입니다.  
2. 재시도와 차이: 재시도는 같은 방식 반복, 폴백은 방식 자체를 변경합니다.  
3. Outpainting 경로:
- 생성형 Outpainting 시도
- 실패 시 재시도(최대 2회)
- 2회 실패 시 안전 배경 패딩으로 전환
4. Transition 경로:
- 생성형 전환 시도
- 실패 시 재시도(최대 2회)
- 2회 실패 시 클래식 전환(크로스페이드 + Ken Burns)으로 전환

---

### 4.4 안전 배경 패딩 방식

1. 블러 확장(blurred cover background) 사용  
2. 배경: cover 스케일 이미지 + 강한 블러  
3. 전경: 리사이즈 원본을 중앙 합성  
4. 옵션: 약한 비네팅/그레인

---

### 4.5 전환 클립

1. 기본: 생성형 전환  
2. 프레임 고정:
- 프레임 0 = 사진 i 강제 합성
- 마지막 프레임 = 사진 i+1 강제 합성
3. 경계 튐 시 인접 2~5프레임 블렌딩  
4. 실패/품질미달 시 클래식 전환 폴백

---

### 4.6 마지막 단독 클립

1. 기본 길이: 4초  
2. 저강도 모션(줌/패닝/미세 패럴랙스)  
3. 변형 감지 시 정지 프레임 연출 전환

---

### 4.7 재시도/백오프(확정)

1. `UploadJob`: 최대 1회, 10초  
2. `CanvasJob(Resize+Pad/Outpaint)`: 최대 2회, 30초 -> 120초  
3. `TransitionJob`: 최대 2회, 60초 -> 180초 (이후 폴백)  
4. `LastClipJob`: 최대 1회, 60초  
5. `RenderJob`: 최대 2회, 20초 -> 60초  
6. `DeliverJob`: 최대 3회, 10초 -> 30초 -> 90초

---

### 4.8 최종 렌더 출력 스펙(확정된 항목)

1. 해상도: `1600x900`  
2. 픽셀 포맷: `yuv420p`  
3. 컨테이너: `mp4`

참고: FPS/비트레이트/오디오 코덱 세부값은 아직 `확실하지 않음`이며 별도 확정이 필요합니다.

---

### 4.9 저장/만료

1. 원본: 14일  
2. 중간 산출물: 7일  
3. 최종 영상: 30일  
4. 다운로드 링크: 48시간  
5. 즉시 삭제 지원: 원본/중간/최종

---

### 4.10 프리뷰

1. 프리뷰 해상도: `800x450`  
2. 워터마크 옵션 가능  
3. 프리뷰 승인 후 최종 렌더

---

### 4.11 모니터링/로그

1. `project_id`, `job_id`, `trace_id` 부여  
2. 구조화 로그(JSON)  
3. 핵심 메트릭:
- 성공률/실패율
- 단계별 처리시간
- 재시도 분포
- 큐 대기시간
- GPU 사용률/메모리
- OOM/타임아웃/폴백 발생률

---

## 5. 구현 우선순위

1. 입력 검증 + 업로드  
2. CanvasJob(리사이즈 + 중앙 배치 + 여백 채움)  
3. 전환 클립 + 프레임 고정  
4. 마지막 단독 클립  
5. 렌더/병합(FFmpeg)  
6. 모니터링/재시도/부분 재생성  
7. 프리뷰/다운로드/만료

---

## 6. 현재 알 수 없는 항목

1. 목표 SLA(P95 포함) 수치: 트래픽/GPU 정보가 없어 `알 수 없습니다`.  
2. 동시 작업 기준 최적 워커 수: 실제 벤치마크 전에는 `확실하지 않음`입니다.  
3. 템플릿별 사용자 선호도: 운영 전 데이터가 없어 `알 수 없습니다`.

---

## 7. 추가 설계 필요 항목(코드 계약 제외)

1. 품질게이트 임계값 수치화
- 피사체 변형 허용치
- 깜빡임/프레임 점프 임계값

2. 렌더 세부 스펙 확정
- FPS(CFR/VFR)
- 비트레이트 또는 CRF 범위
- 오디오 스펙(샘플레이트/비트레이트)

3. Job 타임아웃 정책
- 단계별 최대 실행시간
- 타임아웃 후 재시도/실패 처리 규칙

4. 사용자 고지 정책
- 폴백 적용 여부 표시
- 재생성 요청 UX

5. 운영 대시보드 기준
- 알람 임계치
- 일일 처리량/실패율 리포트 기준

---

## 8. v0.4.1 적용 결과

1. `1600x900` 캔버스 정책이 적용되었습니다.  
2. 재시도 2회, 폴백 진입 조건(Outpainting 2회 실패/전환 2회 실패)이 확정되었습니다.  
3. 최종 렌더 픽셀 포맷 `yuv420p`가 확정되었습니다.  
4. 코드 계약은 요청에 따라 차기 단계로 보류했습니다.
